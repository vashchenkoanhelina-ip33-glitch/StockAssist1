@model StockAssist.Web.Models.Order

@{
    ViewData["Title"] = "Оплата замовлення";

    var monthlyPrice = Model.StoragePricePerMonth;   
    var months = Model.StorageMonths;                    
    var totalAmount = monthlyPrice * months;            
}

<h2 class="fw-bold mb-3">Оплата замовлення №@Model.Id</h2>

<div class="card-glass p-4">
    <form asp-action="Pay"
          asp-controller="Payment"
          asp-route-id="@Model.Id"
          class="needs-validation"
          autocomplete="off"
          novalidate>

        @Html.AntiForgeryToken()

        <input type="text" name="fake-username" autocomplete="username" class="d-none" />
        <input type="password" name="fake-password" autocomplete="new-password" class="d-none" />

        <div class="validation-summary-card d-none mb-3" data-validation-summary></div>

        <div class="row g-4">
            <div class="col-lg-8">
                <h5 class="mb-3">Спосіб оплати</h5>

                <div class="mb-3">
                    <label class="form-label">Будь ласка, оберіть спосіб оплати</label>
                    <select class="form-select"
                            name="paymentMethod"
                            id="paymentMethod"
                            required
                            data-display-name="Спосіб оплати">
                        <option value="">Оберіть спосіб оплати</option>
                        <option value="Visa">Visa</option>
                        <option value="MasterCard">MasterCard</option>
                        <option value="PayLater">Оплатити пізніше</option>
                    </select>
                    <div class="invalid-feedback">
                        Оберіть спосіб оплати.
                    </div>
                </div>

                <div id="cardFields">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Номер картки</label>
                            <input type="text"
                                   class="form-control"
                                   name="cardNumber"
                                   inputmode="numeric"
                                   minlength="16"
                                   maxlength="19"
                                   placeholder="0000 0000 0000 0000"
                                   autocomplete="off"
                                   required
                                   data-display-name="Номер картки" />
                            <div class="invalid-feedback">
                                Введіть номер картки.
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Закінчення дії</label>
                            <input type="text"
                                   class="form-control"
                                   name="cardExpiry"
                                   placeholder="MM/YY"
                                   inputmode="numeric"
                                   autocomplete="off"
                                   pattern="\\d{2}/\\d{2}"
                                   required
                                   data-display-name="Термін дії картки" />
                            <div class="invalid-feedback">
                                Вкажіть термін дії у форматі MM/YY.
                            </div>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">CVV</label>
                            <input type="text"
                                   class="form-control"
                                   name="cvv"
                                   minlength="3"
                                   maxlength="4"
                                   inputmode="numeric"
                                   autocomplete="off"
                                   placeholder="***"
                                   required
                                   data-display-name="CVV-код" />
                            <div class="invalid-feedback">
                                Вкажіть CVV-код (3–4 цифри).
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4" />
                <h5 class="mb-3">Платіжні відомості</h5>

                <div id="billingFields" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Ім’я</label>
                        <input type="text"
                               class="form-control"
                               name="firstName"
                               autocomplete="off"
                               required
                               data-display-name="Імʼя" />
                        <div class="invalid-feedback">
                            Вкажіть ім’я платника.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Прізвище</label>
                        <input type="text"
                               class="form-control"
                               name="lastName"
                               autocomplete="off"
                               required
                               data-display-name="Прізвище" />
                        <div class="invalid-feedback">
                            Вкажіть прізвище платника.
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Адреса для рахунків</label>
                        <input type="text"
                               class="form-control"
                               name="billingAddress"
                               autocomplete="off"
                               required
                               data-display-name="Адресу для рахунків" />
                        <div class="invalid-feedback">
                            Вкажіть адресу для рахунків.
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Місто</label>
                        <input type="text"
                               class="form-control"
                               name="city"
                               autocomplete="off"
                               required
                               data-display-name="Місто" />
                        <div class="invalid-feedback">
                            Вкажіть місто.
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Поштовий індекс</label>
                        <input type="text"
                               class="form-control"
                               name="postalCode"
                               autocomplete="off"
                               required
                               data-display-name="Поштовий індекс" />
                        <div class="invalid-feedback">
                            Вкажіть поштовий індекс.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Країна</label>
                        <input type="text"
                               class="form-control"
                               name="country"
                               value="Україна"
                               autocomplete="off"
                               required
                               data-display-name="Країна" />
                        <div class="invalid-feedback">
                            Вкажіть країну.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Номер телефону</label>
                        <input type="tel"
                               class="form-control"
                               name="phone"
                               autocomplete="off"
                               required
                               data-display-name="Номер телефону" />
                        <div class="invalid-feedback">
                            Вкажіть номер телефону.
                        </div>
                    </div>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="saveCard" name="saveCard">
                    <label class="form-check-label" for="saveCard">
                        Зберегти платіжні дані для майбутніх покупок
                    </label>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card-glass h-100 p-4">
                    <h5 class="mb-3">Підсумок замовлення</h5>

                    <p class="mb-1">
                        <span class="text-muted">Місячна вартість зберігання:</span><br />
                        <strong>@monthlyPrice.ToString("N0") грн / місяць</strong>
                    </p>

                    <p class="mb-1">
                        <span class="text-muted">Кількість місяців:</span><br />
                        <strong>@months</strong>
                    </p>

                    <hr />

                    <p class="mb-1">
                        <span class="text-muted">Сума до оплати:</span><br />
                        <strong class="fs-4">@totalAmount.ToString("N0") грн</strong>
                    </p>

                    <p class="small text-muted mt-2">
                        Після успішної оплати статус замовлення буде оновлено автоматично.
                    </p>

                    <button type="submit"
                            id="payButton"
                            class="btn btn-gradient w-100 mt-3">
                        Оплатити
                    </button>

                    <a asp-controller="Orders"
                       asp-action="Index"
                       class="btn btn-outline-secondary w-100 mt-2">
                        Назад до моїх замовлень
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<div id="payLaterModal" class="paylater-backdrop d-none">
    <div class="paylater-modal card-glass p-4">
        <h5 class="mb-2 fw-semibold">Оплатити пізніше</h5>
        <p class="small mb-3">
            Здійсніть оплату, інакше ваш товар може бути виставлений на аукціон.
            Ви впевнені, що хочете оплатити пізніше?
        </p>

        <div class="d-flex justify-content-end gap-2">
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    id="payLaterCancelBtn">
                Скасувати
            </button>
            <button type="button"
                    class="btn btn-gradient btn-sm"
                    id="payLaterConfirmBtn">
                Оплатити пізніше
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.querySelector('.needs-validation');
            if (!form) return;

            const paymentMethodSelect = document.getElementById('paymentMethod');
            const payLaterModal = document.getElementById('payLaterModal');
            const payLaterConfirmBtn = document.getElementById('payLaterConfirmBtn');
            const payLaterCancelBtn = document.getElementById('payLaterCancelBtn');

            let payLaterOrigin = null; // 'select' або 'submit'

            function showSummary(invalid) {
                const summary = form.querySelector('[data-validation-summary]');
                if (!summary) return;

                if (!invalid || invalid.length === 0) {
                    summary.classList.add('d-none');
                    summary.innerHTML = '';
                    return;
                }

                const names = invalid
                    .map(el => el.getAttribute('data-display-name'))
                    .filter(Boolean);

                if (names.length > 0) {
                    summary.classList.remove('d-none');
                    summary.innerHTML =
                        '<strong>Будь ласка, заповніть:</strong> ' + names.join(', ');
                }
            }

            function openPayLaterModal(origin) {
                payLaterOrigin = origin;
                if (!payLaterModal) return;
                payLaterModal.classList.remove('d-none');
                document.body.classList.add('modal-open');
            }

            function closePayLaterModal() {
                if (!payLaterModal) return;
                payLaterModal.classList.add('d-none');
                document.body.classList.remove('modal-open');
            }

            if (payLaterConfirmBtn) {
                payLaterConfirmBtn.addEventListener('click', function () {

                    window.location.href = '@Url.Action("Index", "Orders")';
                });
            }

            if (payLaterCancelBtn) {
                payLaterCancelBtn.addEventListener('click', function () {
                    closePayLaterModal();

                    if (payLaterOrigin === 'select' && paymentMethodSelect) {
                        paymentMethodSelect.value = '';
                    }
                });
            }

            if (payLaterModal) {
                payLaterModal.addEventListener('click', function (e) {
                    if (e.target === payLaterModal) {
                        closePayLaterModal();
                        if (payLaterOrigin === 'select' && paymentMethodSelect) {
                            paymentMethodSelect.value = '';
                        }
                    }
                });
            }

            if (paymentMethodSelect) {
                paymentMethodSelect.addEventListener('change', function () {
                    if (this.value === 'PayLater') {
                        openPayLaterModal('select');
                    }
                });
            }

            form.addEventListener('submit', function (event) {
                const method = paymentMethodSelect ? paymentMethodSelect.value : '';

                if (method === 'PayLater') {
                    event.preventDefault();
                    event.stopPropagation();
                    openPayLaterModal('submit');
                    return;
                }

                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();

                    const invalid = Array.from(form.querySelectorAll(':invalid'));
                    form.classList.add('was-validated');
                    showSummary(invalid);

                    const firstInvalid = invalid[0];
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                } else {
                    showSummary([]);
                }
            });
        })();
    </script>
}
