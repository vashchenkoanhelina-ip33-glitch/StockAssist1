@using StockAssist.Web.Models
@{
    ViewData["Title"] = "Новий запит";

    var warehouses = ViewBag.Warehouses as IEnumerable<Warehouse>;
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-11">
            <h2 class="fw-bold mb-3">Новий запит на зберігання</h2>
            <p class="mb-3">
                Заповни дані про речі, які хочеш здати на зберігання. Ми розрахуємо вартість
                та створимо замовлення.
            </p>

            @if (!ViewData.ModelState.IsValid &&
                 ViewData.ModelState.Values.Any(v => v.Errors.Count > 0))
            {
                <div class="validation-summary-card">
                    <strong>Упс! Щось пішло не так.</strong>
                    <ul class="mb-0">
                        @foreach (var kvp in ViewData.ModelState)
                        {
                            foreach (var error in kvp.Value.Errors)
                            {
                                <li>@error.ErrorMessage</li>
                            }
                        }
                    </ul>
                </div>
            }

            <div class="wizard-steps mb-4">
                <div class="wizard-step active" data-step="1">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-label">Дата та склад</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-label">Дані по речах</span>
                </div>
                <div class="wizard-step" data-step="3">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-label">Підтвердження</span>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Create" method="post" class="needs-validation" novalidate>
        <div class="row justify-content-center">
            <div class="col-12 col-lg-11">

                <div class="wizard-step-panel" data-step="1">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="card-glass p-4 h-100">
                                <h6 class="mb-3">Дата зберігання</h6>

                                <label class="form-label small">Дата початку</label>
                                <input type="date"
                                       name="plannedDate"
                                       class="form-control"
                                       required />

                                <p class="mt-2 small">
                                    Обери бажану дату початку зберігання.
                                </p>

                                <label class="form-label small mt-3">Кінцева дата (необовʼязково)</label>
                                <input type="date"
                                       name="endDate"
                                       class="form-control" />

                                <p class="mt-2 small">
                                    Якщо вкажеш кінцеву дату — ми порахуємо тривалість.
                                </p>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card-glass p-4 h-100">
                                <h6 class="mb-3">Параметри складу</h6>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small">Склад</label>
                                        <select name="warehouseId"
                                                class="form-select"
                                                required>
                                            <option value="">Оберіть склад</option>
                                            @if (warehouses != null)
                                            {
                                                foreach (var w in warehouses)
                                                {
                                                    <option value="@w.Id">@w.Name</option>
                                                }
                                            }
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label small">Тип послуги</label>
                                        <select name="serviceType"
                                                class="form-select"
                                                required>
                                            <option value="storage">Зберігання</option>
                                        </select>
                                    </div>
                                </div>

                                <p class="mt-3 small text-muted">
                                    Додаткові побажання можна вказати на наступному кроці.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <button type="button"
                                class="btn btn-gradient"
                                data-next-step>
                            Далі: Дані по речах
                        </button>
                    </div>
                </div>

                <div class="wizard-step-panel d-none" data-step="2">
                    <div class="card-glass p-4">
                        <h5 class="mb-3">Дані по речах</h5>

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Що здаєш на зберігання?</label>
                                <input type="text"
                                       name="description"
                                       class="form-control"
                                       required
                                       placeholder="Наприклад: шафа, коробки з одягом тощо" />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Кількість</label>
                                <input type="number"
                                       name="quantity"
                                       class="form-control"
                                       min="1"
                                       value="1"
                                       required />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Вага однієї одиниці (кг)</label>
                                <div class="input-group">
                                    <input type="number"
                                           step="0.01"
                                           min="0.01"
                                           name="weight"
                                           class="form-control"
                                           required />
                                    <span class="input-group-text">kg</span>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Обʼєм однієї одиниці (м³)</label>
                                <div class="input-group">
                                    <input type="number"
                                           step="0.01"
                                           min="0.01"
                                           name="volume"
                                           class="form-control"
                                           required />
                                    <span class="input-group-text">м³</span>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">
                                    Додаткові побажання / примітки (необовʼязково)
                                </label>
                                <textarea name="notes"
                                          class="form-control"
                                          rows="3"
                                          placeholder="Наприклад: крихкі речі, тримати у вертикальному положенні тощо"></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    data-prev-step>
                                Назад
                            </button>
                            <button type="button"
                                    class="btn btn-gradient"
                                    data-next-step>
                                Далі: Підтвердження
                            </button>
                        </div>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div class="wizard-step-panel d-none" data-step="3">
                    <div class="card-glass p-4">
                        <div class="row g-4 align-items-stretch">

                            <div class="col-md-7">
                                <h5 class="mb-3">Підсумок замовлення</h5>

                                <div class="order-summary-box">
                                    <div class="order-summary-row">
                                        <div class="summary-label">Склад</div>
                                        <div class="summary-value" id="summary-warehouse">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Період зберігання</div>
                                        <div class="summary-value" id="summary-date">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Тип послуги</div>
                                        <div class="summary-value" id="summary-service">Зберігання</div>
                                    </div>

                                    <hr class="my-2" />

                                    <div class="order-summary-row">
                                        <div class="summary-label">Опис речей</div>
                                        <div class="summary-value" id="summary-description">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Кількість</div>
                                        <div class="summary-value" id="summary-quantity">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Вага, кг</div>
                                        <div class="summary-value" id="summary-weight">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Обʼєм, м³</div>
                                        <div class="summary-value" id="summary-volume">—</div>
                                    </div>

                                    <div class="order-summary-row">
                                        <div class="summary-label">Додаткові побажання</div>
                                        <div class="summary-value" id="summary-notes">—</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-5">
                                <div class="payment-panel h-100 d-flex flex-column">
                                    <div class="payment-panel-header mb-3">
                                        <h5 class="mt-3 mb-1">Оплата замовлення</h5>
                                        <p class="text-muted mb-0 small">
                                            Перевір дані та підтверди оплату — після цього замовлення одразу піде в обробку.
                                        </p>
                                    </div>

                                    <div class="payment-panel-body mb-3">
                                        <div class="text-muted small mb-1">Сума до оплати</div>

                                        <div class="payment-amount-line d-flex align-items-baseline gap-2">
                                            <div class="payment-amount" id="summary-total">— грн</div>
                                            <span class="badge rounded-pill bg-light text-dark payment-badge">
                                                за весь період зберігання
                                            </span>
                                        </div>

                                        <div class="payment-details small mt-2" id="summary-total-details">
                                            &nbsp;
                                        </div>
                                    </div>

                                    <div class="mt-auto">
                                        <input type="hidden" name="method" value="Card" />

                                        <button type="submit" class="btn btn-gradient w-100 mb-2">
                                            Створити запит та перейти до оплати
                                        </button>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-start mt-3">
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm"
                                            data-prev-step>
                                        Назад до редагування
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function () {
            const steps = Array.from(document.querySelectorAll('.wizard-step'));
            const panels = Array.from(document.querySelectorAll('.wizard-step-panel'));
            let currentStep = 1;

            function setStep(step) {
                currentStep = step;
                steps.forEach(s => {
                    const n = Number(s.dataset.step);
                    s.classList.toggle('active', n === step);
                });
                panels.forEach(p => {
                    const n = Number(p.dataset.step);
                    p.classList.toggle('d-none', n !== step);
                });
            }

            setStep(1);

            function validateCurrentStep() {
                const panel = panels.find(p => Number(p.dataset.step) === currentStep);
                if (!panel) return true;

                const inputs = panel.querySelectorAll('input, select, textarea');
                for (let el of inputs) {
                    if (el.hasAttribute('required') && !el.checkValidity()) {
                        el.reportValidity();
                        return false;
                    }
                }
                return true;
            }

            document.querySelectorAll('[data-next-step]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!validateCurrentStep()) return;

                    if (currentStep === 2) {
                        updateSummary();
                    }
                    if (currentStep < 3) setStep(currentStep + 1);
                });
            });

            document.querySelectorAll('[data-prev-step]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentStep > 1) setStep(currentStep - 1);
                });
            });

            function updateSummary() {
                const get = (name) => document.querySelector('[name="' + name + '"]');

                const whSel = get('warehouseId');
                const whText = whSel && whSel.selectedIndex >= 0
                    ? whSel.options[whSel.selectedIndex].text
                    : '—';

                const startRaw = get('plannedDate')?.value || '';
                const endRaw = get('endDate')?.value || '';
                let dateText = '—';

                if (startRaw && endRaw) {
                    dateText = `${startRaw} – ${endRaw}`;
                } else if (startRaw) {
                    dateText = startRaw;
                }

                document.getElementById('summary-warehouse').innerText = whText;
                document.getElementById('summary-date').innerText = dateText;
                document.getElementById('summary-description').innerText = get('description')?.value || '—';
                document.getElementById('summary-quantity').innerText = get('quantity')?.value || '—';
                document.getElementById('summary-weight').innerText = get('weight')?.value || '—';
                document.getElementById('summary-volume').innerText = get('volume')?.value || '—';
                document.getElementById('summary-notes').innerText = get('notes')?.value || '—';
                document.getElementById('summary-service').innerText = "Зберігання";

                const quantity = Number(get('quantity')?.value || 1);
                const weight = Number(get('weight')?.value || 0);
                const volume = Number(get('volume')?.value || 0);

                let storageMonths = 1;
                if (startRaw && endRaw) {
                    const startDate = new Date(startRaw);
                    const endDate = new Date(endRaw);
                    const diffMs = endDate - startDate;
                    const diffDays = diffMs / (1000 * 60 * 60 * 24);
                    if (diffDays > 0) {
                        storageMonths = Math.ceil(diffDays / 30);
                    }
                }

                const pricePerBlockPerMonth = 1000;
                const weightBlocks = weight > 0 ? Math.ceil(weight / 20) : 0;
                const volumeBlocks = volume > 0 ? Math.ceil(volume / 4) : 0;
                const bundles = Math.max(weightBlocks, volumeBlocks);

                const summaryTotal = document.getElementById('summary-total');
                const summaryDetails = document.getElementById('summary-total-details');

                if (bundles > 0 && quantity > 0 && storageMonths > 0) {
                    const total = bundles * pricePerBlockPerMonth * quantity * storageMonths;
                    summaryTotal.innerText = total.toLocaleString('uk-UA') + " грн";

                    summaryDetails.innerText =
                        `${bundles} блок(ів) × 1000 грн × ${quantity} шт × ${storageMonths} міс.`;
                } else {
                    summaryTotal.innerText = "— грн";
                    summaryDetails.innerText = "";
                }
            }
        })();
    </script>
}
